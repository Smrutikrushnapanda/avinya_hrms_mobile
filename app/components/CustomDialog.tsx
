import LottieView from 'lottie-react-native';
import React, { useEffect, useRef } from 'react';
import {
  Dimensions,
  StyleSheet,
  Text,
  TouchableOpacity,
  View
} from 'react-native';
import Modal from 'react-native-modal';

const { width } = Dimensions.get('window');

type DialogType = 'SUCCESS' | 'DANGER' | 'WARNING' | 'INFO';

interface DialogButton {
  text: string;
  onPress: () => void;
  style?: 'default' | 'cancel' | 'destructive';
}

interface DialogConfig {
  animation: any;
  backgroundColor: string;
  textColor: string;
  buttonColor: string;
}

interface CustomDialogProps {
  isVisible: boolean;
  type: DialogType;
  title: string;
  message: string;
  buttons?: DialogButton[];
  onConfirm?: () => void;
  onCancel?: () => void;
  autoCloseTimeout?: number;
}

const DIALOG_TYPES: Record<DialogType, DialogConfig> = {
  SUCCESS: {
    animation: require('../../assets/images/Success.json'),
    backgroundColor: 'rgba(0, 128, 0, 0.15)',
    textColor: '#008000',
    buttonColor: '#4CAF50',
  },
  DANGER: {
    animation: require('../../assets/images/Alert.json'),
    backgroundColor: 'rgba(255, 0, 0, 0.15)',
    textColor: '#FF0000',
    buttonColor: '#F44336',
  },
  WARNING: {
    animation: require('../../assets/images/Warning.json'),
    backgroundColor: 'rgba(255, 165, 0, 0.15)',
    textColor: '#FFA500',
    buttonColor: '#FF9800',
  },
  INFO: {
    animation: require('../../assets/images/information.json'),
    backgroundColor: 'rgba(0, 0, 255, 0.15)',
    textColor: '#2196F3',
    buttonColor: '#2196F3',
  },
};

const CustomDialog: React.FC<CustomDialogProps> = ({
  isVisible,
  type,
  title,
  message,
  buttons,
  onConfirm,
  onCancel,
  autoCloseTimeout = 0,
}) => {
  const config = DIALOG_TYPES[type] || DIALOG_TYPES.INFO;
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);

  useEffect(() => {
    if (isVisible && autoCloseTimeout > 0) {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
      
      timeoutRef.current = setTimeout(() => {
        if (onConfirm) {
          onConfirm();
        } else if (buttons && buttons.length > 0) {
          buttons[0].onPress();
        } else {
          onCancel?.();
        }
      }, autoCloseTimeout);
    }

    return () => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
        timeoutRef.current = null;
      }
    };
  }, [isVisible, autoCloseTimeout, onConfirm, buttons, onCancel]);

  const handleButtonPress = (button: DialogButton) => {
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
      timeoutRef.current = null;
    }
    button.onPress();
  };

  const handleCancel = () => {
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
      timeoutRef.current = null;
    }
    onCancel?.();
  };

  // If buttons are provided, use them; otherwise create a default OK button
  const displayButtons = buttons && buttons.length > 0 
    ? buttons 
    : onConfirm 
      ? [{ text: 'OK', onPress: onConfirm, style: 'default' as const }]
      : [{ text: 'OK', onPress: handleCancel, style: 'default' as const }];

  // Don't render if not visible
  if (!isVisible) return null;

  return (
    <Modal
      isVisible={isVisible}
      animationIn="fadeIn"
      animationOut="fadeOut"
      animationInTiming={300}
      animationOutTiming={200}
      backdropOpacity={0.3}
      onBackdropPress={handleCancel}
      onBackButtonPress={handleCancel}
      style={styles.modal}
      useNativeDriver={true}
      hideModalContentWhileAnimating={true}
    >
      <View
        style={[
          styles.dialogContainer,
          { backgroundColor: config.backgroundColor },
        ]}
      >
        <View style={styles.glassOverlay} />
        
        <LottieView
          source={config.animation}
          autoPlay
          loop={false}
          style={styles.animation}
        />
        <Text style={[styles.title, { color: config.textColor }]}>{title}</Text>
        <Text style={styles.message}>{message}</Text>
        
        <View style={styles.buttonContainer}>
          {displayButtons.map((button, index) => (
            <TouchableOpacity
              key={index}
              style={[
                styles.button,
                { backgroundColor: config.buttonColor },
                button.style === 'cancel' && styles.cancelButton,
                button.style === 'destructive' && styles.destructiveButton,
                displayButtons.length === 1 && styles.singleButton,
                displayButtons.length === 2 && styles.doubleButton,
              ]}
              onPress={() => handleButtonPress(button)}
              activeOpacity={0.8}
            >
              <Text style={[
                styles.buttonText,
                button.style === 'cancel' && styles.cancelButtonText,
              ]}>
                {button.text}
              </Text>
            </TouchableOpacity>
          ))}
        </View>
      </View>
    </Modal>
  );
};

const styles = StyleSheet.create({
  modal: {
    justifyContent: 'center',
    alignItems: 'center',
    margin: 0,
  },
  dialogContainer: {
    width: width * 0.85,
    padding: 25,
    borderRadius: 20,
    alignItems: 'center',
    shadowColor: '#000',
    shadowOffset: {
      width: 0,
      height: 4,
    },
    shadowOpacity: 0.15,
    shadowRadius: 8,
    elevation: 8,
    borderWidth: 1,
    borderColor: 'rgba(154, 154, 154, 0.9)',
    overflow: 'hidden',
  },
  glassOverlay: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    backgroundColor: 'rgba(255, 255, 255, 1)',
  },
  animation: {
    width: 100,
    height: 100,
    zIndex: 1,
  },
  title: {
    fontSize: 22,
    fontWeight: 'bold',
    marginVertical: 12,
    zIndex: 1,
    textShadowColor: 'rgba(0, 0, 0, 0.1)',
    textShadowOffset: { width: 0, height: 1 },
    textShadowRadius: 2,
  },
  message: {
    fontSize: 16,
    textAlign: 'center',
    marginBottom: 25,
    color: '#333',
    lineHeight: 22,
    zIndex: 1,
  },
  buttonContainer: {
    flexDirection: 'row',
    justifyContent: 'center',
    alignItems: 'center',
    width: '100%',
    zIndex: 1,
  },
  button: {
    paddingHorizontal: 25,
    paddingVertical: 12,
    borderRadius: 25,
    minWidth: 100,
    alignItems: 'center',
    justifyContent: 'center',
    shadowColor: '#000',
    shadowOffset: {
      width: 0,
      height: 2,
    },
    shadowOpacity: 0.2,
    shadowRadius: 4,
    elevation: 4,
    marginHorizontal: 5,
  },
  singleButton: {
    minWidth: 150,
  },
  doubleButton: {
    minWidth: 120,
    flex: 1,
    maxWidth: 150,
  },
  cancelButton: {
    backgroundColor: '#9E9E9E',
  },
  destructiveButton: {
    backgroundColor: '#F44336',
  },
  buttonText: {
    color: '#fff',
    fontSize: 16,
    fontWeight: '600',
    textTransform: 'uppercase',
    letterSpacing: 1,
  },
  cancelButtonText: {
    color: '#fff',
  },
});

export default CustomDialog;

